# 유니그린 SaaS - 비즈니스 워크플로우 문서

## 1. 개요

본 문서는 유니그린 누수 진단 및 건설 관리 시스템의 엔드투엔드 비즈니스 워크플로우를 설명합니다.

### 1.1 워크플로우 단계

```
┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
│ 현장방문  │ → │ 사진촬영  │ → │ 누수진단  │ → │ 견적작성  │
└──────────┘   └──────────┘   └──────────┘   └──────────┘
                                                  │
     ┌────────────────────────────────────────────┘
     ▼
┌──────────┐   ┌──────────┐   ┌──────────┐
│ 계약진행  │ → │ 노무비   │ → │ 계약마무리│
│          │   │ 관리     │   │          │
└──────────┘   └──────────┘   └──────────┘
```

---

## 2. 단계 1: 현장방문

### 2.1 설명
현장 기술자가 초기 평가를 위해 건설 현장을 방문합니다.

### 2.2 참여자
- **주요**: 현장 기술자 (모바일 앱)
- **부수**: 사무실 관리자 (알림 수신)

### 2.3 프로세스 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    모바일 앱                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 기술자가 앱 실행                                        │
│     └─→ 배정된 프로젝트 보기 또는 새 프로젝트 생성           │
│                                                             │
│  2. 프로젝트 선택/생성                                      │
│     └─→ 입력: 이름, 주소, 발주처 정보                       │
│                                                             │
│  3. 현장방문 시작                                           │
│     └─→ 시스템 기록: 기술자, 타임스탬프, GPS                │
│                                                             │
│  4. 사진촬영으로 이동                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 생성되는 데이터

| 엔티티 | 필드 |
|--------|------|
| Project | name, address, client_name, client_phone |
| SiteVisit | project_id, technician_id, visit_type, visited_at |

### 2.5 UI 화면

**프로젝트 목록 (모바일)**
```
┌─────────────────────────────────────────┐
│  ← 프로젝트 목록                    [+] │
├─────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │ 강남아파트 옥상방수                 │ │
│ │ 📍 서울시 강남구 테헤란로 123      │ │
│ │ ● 진단중            2026.01.04    │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │ 분당빌딩 지하방수                   │ │
│ │ 📍 성남시 분당구 ...               │ │
│ │ ● 견적중            2026.01.03    │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│  [🏠]    [📋]    [➕]    [👤]          │
└─────────────────────────────────────────┘
```

---

## 3. 단계 2: 사진촬영

### 3.1 설명
기술자가 AI 분석을 위해 누수/손상 부위 사진을 촬영합니다.

### 3.2 요구사항
- 복수 사진 촬영 (권장: 5-10장)
- 분류: 공사전/상세 촬영
- 선택: 사진별 캡션 추가
- 오프라인 지원: 연결 복구 시 업로드 큐잉

### 3.3 프로세스 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    모바일 앱                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 카메라 인터페이스                                       │
│     └─→ 네이티브 카메라 접근 (Flutter)                      │
│     └─→ 오버레이: "공사전" / "상세" 선택기                  │
│                                                             │
│  2. 검토 및 태그                                            │
│     └─→ 촬영한 사진 미리보기                               │
│     └─→ 캡션 추가 (선택)                                   │
│     └─→ 필요시 삭제/재촬영                                 │
│                                                             │
│  3. 업로드 (비동기)                                         │
│     └─→ 진행률 표시기                                      │
│     └─→ 실패 시 자동 재시도                                │
│                                                             │
│  4. 완료 & 진단 요청                                        │
│     └─→ [AI 누수진단 요청] 버튼                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 생성되는 데이터

| 엔티티 | 필드 |
|--------|------|
| Photo | site_visit_id, storage_path, photo_type, caption, taken_at |

---

## 4. 단계 3: AI 누수진단

### 4.1 설명
Gemini 3.0 Flash가 업로드된 사진을 분석하여 생성합니다:
1. **누수소견서**: 상세한 텍스트 평가
2. **자재 추천**: 추천 자재 및 수량

### 4.2 AI 연동 흐름 (비동기)

```
┌─────────────────────────────────────────────────────────────┐
│                    백엔드 (FastAPI)                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 진단 요청 수신 (즉시 응답)                              │
│     └─→ diagnosis_id 반환, 상태: "processing"              │
│                                                             │
│  2. 백그라운드 작업 시작                                    │
│     ├─→ 스토리지에서 사진 로드 (비동기)                    │
│     ├─→ 시스템 지침으로 프롬프트 구성                       │
│     └─→ 구조화된 JSON 출력 요청                            │
│                                                             │
│  3. Gemini 3.0 Flash 호출 (비동기)                          │
│     └─→ 멀티모달: 이미지 + 텍스트                          │
│                                                             │
│  4. 응답 파싱                                               │
│     ├─→ leak_opinion_text 추출                             │
│     └─→ suggested_materials[] 추출                         │
│                                                             │
│  5. 카탈로그 매칭 (비동기, 병렬)                            │
│     ├─→ 이름으로 퍼지 매칭                                 │
│     ├─→ 임베딩 유사도 (선택)                               │
│     └─→ match_confidence 점수 부여                         │
│                                                             │
│  6. 결과 저장 및 상태 업데이트                              │
│     └─→ 상태: "completed" 또는 "failed"                    │
│                                                             │
│  7. 클라이언트 폴링으로 결과 확인                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 Gemini 프롬프트 구조

```json
{
  "system": "당신은 20년 경력의 방수/누수 전문가입니다...",
  "output_format": {
    "leak_opinion": "소견서 본문 (300자 이상)",
    "leak_severity": "low|medium|high|critical",
    "suggested_materials": [
      {
        "name": "자재명",
        "specification": "규격",
        "unit": "단위",
        "quantity": "숫자",
        "reason": "추천 사유"
      }
    ],
    "construction_method": "권장 시공 방법",
    "estimated_duration_days": "숫자"
  }
}
```

### 4.4 생성되는 데이터

| 엔티티 | 필드 |
|--------|------|
| AIDiagnosis | site_visit_id, model_name, leak_opinion_text, confidence_score, status |
| AIMaterialSuggestion | diagnosis_id, suggested_name, suggested_quantity, matched_catalog_item_id |

---

## 5. 단계 4: 견적서 작성

### 5.1 설명
AI 추천을 단가표 데이터베이스를 사용하여 공식 비용 견적으로 변환합니다.

### 5.2 견적 산출 로직

```
입력:
├─→ AI 추천 자재 (이름, 규격, 수량)
├─→ 활성 단가표 버전
└─→ 프로젝트 메타데이터

처리:
1. 각 추천 자재에 대해:
   a. catalog_item 매칭 (별칭 또는 임베딩으로)
   b. catalog_item_price에서 단가 조회
   c. 계산: 금액 = 수량 × 단가

2. RAG로 적용 규정 확인:
   └─→ "10층 이상은 노무비 5% 할증" 등

3. 합계 계산:
   소계 = Σ(항목별 금액)
   부가세 = 소계 × 0.1
   합계 = 소계 + 부가세

출력:
└─→ Estimate (초안) 및 항목들
```

### 5.3 핵심 기능
1. **편집 가능**: 수량, 단가, 항목 추가/삭제
2. **버전 관리**: 프로젝트당 복수 견적 버전
3. **가격 스냅샷**: 발행 시점에 가격 고정
4. **내보내기**: Excel/PDF 다운로드

### 5.4 생성되는 데이터

| 엔티티 | 필드 |
|--------|------|
| Estimate | project_id, version, pricebook_revision_id, status, totals |
| EstimateLine | estimate_id, catalog_item_id, description, quantity, unit_price_snapshot, amount |

---

## 6. 단계 5: 계약진행

### 6.1 설명
수락된 견적서를 전자서명이 포함된 공식 계약으로 변환합니다.

### 6.2 프로세스 흐름

```
1. 견적서 발행
   └─→ 상태: draft → issued, 가격 잠금

2. 발주처 검토
   └─→ 이메일/링크로 발송
   └─→ 발주처 수락 또는 수정 요청

3. 계약서 생성
   └─→ 견적서에서 자동 채움
   └─→ 약관 추가

4. 전자서명
   └─→ 자사 서명
   └─→ 발주처 서명 (링크 통해)

5. 프로젝트 활성화
   └─→ 상태: contracted → in_progress
   └─→ 자재발주, 노무계약 생성 활성화
```

### 6.3 사진 관리 (공사 전/중/후)

```
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│  공사 전    │   │  공사 중    │   │  공사 후    │
└─────────────┘   └─────────────┘   └─────────────┘
      │                 │                 │
      └─────────────────┼─────────────────┘
                        ▼
              ┌─────────────────┐
              │  준공사진첩      │
              │  (자동 생성)    │
              └─────────────────┘
```

---

## 7. 단계 6: 노무비 관리

### 7.1 설명
일용직 계약, 서명, 지급을 관리합니다.

### 7.2 프로세스 흐름

```
1. 일용 계약 생성
   └─→ 근로자 이름, 연락처, 주민번호
   └─→ 근무일, 직종, 일당

2. 서명 요청 발송
   └─→ SMS/카카오톡으로 서명 링크 발송

3. 근로자 서명 (모바일)
   └─→ 계약 조건 확인
   └─→ 화면에 서명 작성
   └─→ 제출

4. 추적 및 관리
   └─→ 프로젝트별 모든 계약 목록
   └─→ 총 노무비 계산
   └─→ 급여용 내보내기
```

---

## 8. 단계 7: 계약마무리

### 8.1 설명
프로젝트를 완료하고 하자보증 기간을 시작합니다.

### 8.2 프로세스 흐름

```
1. 준공 보고서
   └─→ "공사후" 사진 업로드
   └─→ 준공사진첩 생성 (전/후 비교)
   └─→ 준공증명서 생성

2. 최종 정산
   └─→ 총 비용 확인

3. 하자보증 활성화
   └─→ warranty_expires_at = completed_at + 3년
   └─→ 상태: completed → warranty

4. 하자보증 서비스 (AS)
   └─→ 3년 내 하자 신고 시:
       ├─→ 원 시공 부위 여부 확인
       └─→ 해당 시 후속 프로젝트 생성
```

---

## 9. 프로젝트 상태 전환

```
       ┌─────────┐
       │  draft  │ (초안)
       └────┬────┘
            │ [현장방문 시작]
            ▼
       ┌─────────────┐
       │ diagnosing  │ (진단중)
       └──────┬──────┘
              │ [견적서 작성 시작]
              ▼
       ┌─────────────┐
       │ estimating  │ (견적중)
       └──────┬──────┘
              │ [견적서 발행]
              ▼
        ┌─────────┐
        │ quoted  │ (견적발송)
        └────┬────┘
             │ [계약 체결]
             ▼
      ┌────────────┐
      │ contracted │ (계약완료)
      └─────┬──────┘
            │ [공사 시작]
            ▼
      ┌─────────────┐
      │ in_progress │ (공사중)
      └──────┬──────┘
             │ [공사 완료]
             ▼
       ┌───────────┐
       │ completed │ (준공)
       └─────┬─────┘
             │ [자동]
             ▼
        ┌──────────┐
        │ warranty │ (하자보증)
        └──────────┘
```

---

## 10. 알림 트리거

| 이벤트 | 수신자 | 채널 |
|-------|-------|------|
| 진단 완료 | 기술자 | 푸시/SMS |
| 견적 발행 | 발주처 | 이메일 |
| 계약 준비 | 모든 당사자 | 이메일 |
| 서명 요청 | 근로자 | SMS |
| 보증 만료 예정 | 관리자 | 이메일 |

---

## 11. 버전 이력

| 버전 | 날짜 | 변경 내용 |
|-----|------|----------|
| 0.1.0 | 2026-01-04 | 최초 작성 |
| 0.2.0 | 2026-01-04 | 한글화, 비동기 패턴 반영 |
